<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pauls Model Glider flying Site Guide - Isle of Man Weather</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- Production CSS (built by CI into /dist/styles.css) -->
  <link rel="stylesheet" href="/dist/styles.css" />

  <!-- Fallback small runtime styles -->
  <style>
    #streetFrameWrapper { transition: opacity 300ms ease; opacity: 1; }
    .fade-hidden { opacity: 0 !important; pointer-events: none; }
    #streetFrameWrapper img.site-photo { width: 100%; height: 100%; object-fit: cover; display: block; border: 0; }

    #compassNeedleImg { width: 96px; height: auto; transform-origin: 50% 50%; transform: rotate(0deg); transition: transform 600ms ease; display: block; pointer-events: none; }
    .compass-dial { transition: transform 600ms ease; transform: rotate(0deg); }

    @keyframes spin-dynamic { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .weather-spin { animation-name: spin-dynamic; animation-timing-function: linear; animation-iteration-count: infinite; animation-duration: var(--weather-spin-duration, 2s); transform-origin: 50% 50%; display: inline-block; transition: animation-duration 0.5s ease; }

    .temp-change { animation: pulse 2s infinite alternate ease-in-out; }
    @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }

    .embed-full { width: 100%; height: 100%; border: 0; display: block; }
    .toggle-btn { padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .toggle-active { background-color: rgba(0,160,160,1); color: white; }
    .toggle-inactive { background-color: rgba(0,0,0,0.06); color: inherit; }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">
  <div class="flex flex-col min-h-screen">
    <header class="bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-300 dark:border-gray-700">
      <div class="container mx-auto px-2 sm:px-4 lg:px-6">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-primary text-3xl">waves</span>
            <h1 class="text-xl font-bold text-gray-900 dark:text-white">Pauls Model Glider flying Site Guide</h1>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-grow container mx-auto px-2 sm:px-4 lg:px-6 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <div class="lg:col-span-2 space-y-6">
          <section id="radar-section" class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl md:text-2xl font-bold text-primary text-center flex-1">Weather Radar</h2>
              <div id="radarToggle" class="ml-3 flex gap-2">
                <button id="btnWindy" class="toggle-btn toggle-inactive">Windy</button>
                <button id="btnOpenMeteo" class="toggle-btn toggle-active">Open‑Meteo</button>
              </div>
            </div>
            <div class="bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden h-[360px] md:h-[50vh]">
              <iframe
                id="weatherRadarIframe"
                class="embed-full"
                title="Weather radar"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                data-src="https://embed.windy.com/embed2.html?lat=54.236&lon=-4.548&zoom=8&level=surface&overlay=wind&menu=&message=true&marker=&calendar=now&pressure=true&type=map&location=coordinates&detail=true&metricWind=mph&metricTemp=%C2%B0C&radarRange=-1"
                src=""
              ></iframe>
            </div>
          </section>

          <section id="map-section" class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl md:text-2xl font-bold mb-3 text-primary text-center">Flying Site Map</h2>
            <div class="rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600">
              <div id="wind-map" style="height:420px; border-radius:12px;"></div>
            </div>
          </section>
        </div>

        <div class="lg:col-span-3 space-y-6">
          <section id="conditions-section" class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg border border-gray-300 dark:border-gray-700">
            <h2 class="text-2xl font-bold mb-4 text-primary text-center">Current Conditions: Isle of Man</h2>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              <div class="flex flex-col items-center justify-center bg-background-light dark:bg-background-dark p-5 rounded-lg text-center shadow-md border border-gray-300 dark:border-gray-600">
                <span class="material-symbols-outlined text-primary text-4xl mb-3 weather-spin">air</span>
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Wind Speed</p>
                <p id="windSpeed" class="text-3xl font-bold text-gray-900 dark:text-white temp-change">-- <span class="text-xl font-normal">mph</span></p>
                <p id="windGust" class="text-sm text-text-muted-light mt-1">Gusts: -- mph</p>
                <p id="windDirDegrees" class="text-sm text-text-muted-light dark:text-text-muted-dark mt-1">Direction: --</p>
              </div>

              <div class="flex flex-col items-center justify-center bg-background-light dark:bg-background-dark p-5 rounded-lg text-center shadow-md border border-gray-300 dark:border-gray-600">
                <div class="relative w-32 h-32">
                  <div class="absolute inset-0 border-4 border-primary/20 rounded-full animate-pulse"></div>
                  <div class="absolute inset-0 compass-dial flex items-center justify-center">
                    <img id="compassNeedleImg" src="assets/glider-needle.png" alt="glider needle" />
                  </div>
                </div>
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark mt-3">Wind Direction</p>
                <p id="windDirLabel" class="text-2xl font-bold text-gray-900 dark:text-white mt-2 min-h-[2.5rem] flex items-center justify-center">--</p>
              </div>

              <div class="space-y-4 bg-background-light dark:bg-background-dark p-5 rounded-lg shadow-md border border-gray-300 dark:border-gray-600 flex flex-col justify-center">
                <div class="flex items-center gap-3">
                  <span class="material-symbols-outlined text-primary">device_thermostat</span>
                  <div>
                    <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Temperature</p>
                    <p id="temp" class="font-bold text-gray-900 dark:text-white text-2xl temp-change">--°C</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="material-symbols-outlined text-primary">humidity_percentage</span>
                  <div>
                    <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Humidity</p>
                    <p id="humidity" class="font-bold text-gray-900 dark:text-white text-2xl">--%</p>
                  </div>
                </div>
                <p id="updated" class="text-xs text-text-muted-light dark:text-text-muted-dark mt-2">Last update: --</p>
              </div>
            </div>
          </section>

          <section id="street-view" class="w-full bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-lg border border-gray-300 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
              <h2 id="streetLabel" class="text-2xl font-bold text-primary">Street View</h2>
              <div class="flex items-center gap-3">
                <button id="picturesBtn" class="toggle-btn bg-primary text-white hover:bg-primary/80 transition px-4 py-2 rounded-lg text-base font-semibold flex items-center gap-2" title="Show photos for this wind direction">
                  <span class="material-symbols-outlined">photo_library</span> Pictures
                </button>
                <button id="altSiteBtn" class="toggle-btn bg-primary text-white hover:bg-primary/80 transition px-5 py-2 rounded-lg text-base font-semibold flex items-center gap-2" title="Cycle alternate views for this wind direction">
                  <span class="material-symbols-outlined animate-spin-slow">refresh</span> Alt Site
                </button>
              </div>
            </div>
            <div id="streetFrameWrapper" class="rounded-lg overflow-hidden shadow-inner transition-opacity duration-500 opacity-100" style="height:420px;">
              <iframe id="streetFrame" class="embed-full" title="Street View" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
          </section>

          <section id="forecast-section" class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg border border-gray-300 dark:border-gray-700">
            <h2 class="text-2xl font-bold mb-4 text-primary text-center">Forecast</h2>

            <div id="forecastStrip" class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3"></div>

            <div class="space-y-5 mt-6">
              <div>
                <h3 class="font-bold text-primary text-xl">Next 24 Hours</h3>
                <p id="textForecast" class="text-text-light dark:text-text-dark leading-relaxed">Loading...</p>
              </div>
              <hr class="border-gray-300 dark:border-gray-600" />
              <div>
                <h3 class="font-bold text-primary text-xl">What Glider to Use</h3>
                <p id="gliderAdvice" class="text-text-light dark:text-text-dark leading-relaxed font-semibold">Loading recommendation…</p>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>

    <footer class="bg-background-light dark:bg-background-dark mt-8 border-t border-gray-300 dark:border-gray-700">
      <div class="container mx-auto px-2 sm:px-4 lg:px-6 py-4 text-center text-sm text-text-muted-light dark:text-text-muted-dark">
        <p>© 2025 Pauls Model Glider. All rights reserved.</p>
      </div>
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // Helper
    function el(id) { return document.getElementById(id); }

    // Init Leaflet map
    if (typeof L !== 'undefined' && el('wind-map')) {
      try {
        window._windMapInstance = L.map('wind-map', { preferCanvas: true }).setView([54.236, -4.495], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(window._windMapInstance);
      } catch (e) { console.warn('Leaflet init failed:', e); }
    }

    // Compass rotation (dial + needle)
    function applyCompassRotation(windDeg) {
      if (windDeg === null || windDeg === undefined) return;
      const n = Number(windDeg);
      if (isNaN(n)) return;
      const raw = ((n % 360) + 360) % 360;
      const dial = document.querySelector('.compass-dial');
      if (dial) dial.style.transform = `rotate(${raw}deg)`;
      const needleImg = document.getElementById('compassNeedleImg');
      if (needleImg) {
        const CORRECTION = 180;
        needleImg.style.transform = `rotate(${(raw + CORRECTION) % 360}deg)`;
      }
    }

    // Minimal placeholders for functions referenced elsewhere in scripts to avoid ReferenceError
    window.updateGliderAdvice = window.updateGliderAdvice || function() {};
    window.updateWeatherIconSpin = window.updateWeatherIconSpin || function() {};

    // Basic initial street view fallback
    (function ensureInitialStreetView() {
      const wrapper = el('streetFrameWrapper');
      if (!wrapper) return;
      if (!wrapper.querySelector('iframe') && !wrapper.querySelector('img')) {
        const iframe = document.createElement('iframe');
        iframe.id = 'streetFrame';
        iframe.className = 'embed-full';
        iframe.title = 'Street View';
        iframe.loading = 'lazy';
        iframe.referrerPolicy = 'no-referrer-when-downgrade';
        iframe.src = '';
        wrapper.appendChild(iframe);
      }
    })();
  </script>

  <!-- Weather: Open-Meteo unified fetch + render -->
  <script>
    const LAT = 54.236, LON = -4.548;

    function degToCardinal(deg) {
      if (typeof deg !== 'number' || isNaN(deg)) return '--';
      const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      const idx = Math.floor((((deg % 360) + 360) % 360) / 22.5 + 0.5) % 16;
      return dirs[idx];
    }

    function spinDurationForWindSpeed(mph) {
      if (mph === null || mph === undefined || isNaN(Number(mph))) return 2;
      const v = Math.max(0, Math.min(40, Number(mph)));
      const MIN_DUR = 0.35, MAX_DUR = 3.5;
      const t = MAX_DUR - (v / 40) * (MAX_DUR - MIN_DUR);
      return Math.max(MIN_DUR, Math.min(MAX_DUR, t));
    }

    function updateWeatherIconSpin(mph) {
      const dur = spinDurationForWindSpeed(mph);
      document.documentElement.style.setProperty('--weather-spin-duration', `${dur}s`);
      document.querySelectorAll('.material-symbols-outlined.weather-spin, .weather-spin').forEach(el => {
        if (!el.classList.contains('weather-spin')) el.classList.add('weather-spin');
      });
    }

    async function fetchAndRenderWeather() {
      try {
        const vars = ['temperature_2m','relative_humidity_2m','wind_speed_10m','wind_direction_10m','wind_gusts_10m','precipitation','weathercode'];
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=${vars.join(',')}&timezone=auto&forecast_days=2`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Open-Meteo request failed: ' + res.status);
        const data = await res.json();
        const hourly = data.hourly || null;

        function pickHourlyNearest(variable) {
          if (!hourly || !hourly.time) return null;
          const times = hourly.time; const now = Date.now();
          let nearestIdx = 0, nearestDiff = Infinity;
          for (let i = 0; i < times.length; i++) {
            const t = Date.parse(times[i]); const diff = Math.abs(t - now);
            if (diff < nearestDiff) { nearestDiff = diff; nearestIdx = i; }
          }
          return hourly[variable] && hourly[variable].length > nearestIdx ? hourly[variable][nearestIdx] : null;
        }

        const temp = pickHourlyNearest('temperature_2m');
        const windSpeed = pickHourlyNearest('wind_speed_10m');
        const windDirDeg = pickHourlyNearest('wind_direction_10m');
        const rawHumidity = pickHourlyNearest('relative_humidity_2m');
        const windGust = pickHourlyNearest('wind_gusts_10m') ?? null;

        if (el('temp') && temp !== null) el('temp').textContent = `${Math.round(temp)}°C`;

        (function updateHumidityDisplay() {
          const raw = rawHumidity;
          const humEl = el('humidity'); if (!humEl) return;
          if (raw !== null && !isNaN(Number(raw))) {
            const resolved = Math.max(0, Math.min(100, Math.round(Number(raw))));
            humEl.textContent = `${resolved}%`;
            humEl.title = `Open‑Meteo hourly humidity: ${raw}`;
          } else {
            humEl.textContent = `--`;
            humEl.title = `Humidity data unavailable`;
          }
        })();

        if (el('windSpeed') && windSpeed !== null) el('windSpeed').innerHTML = `${Math.round(windSpeed)} <span class="text-xl font-normal">mph</span>`;
        if (el('windGust')) {
          if (windGust !== null) { el('windGust').textContent = `Gusts: ${Math.round(windGust)} mph`; el('windGust').classList.remove('opacity-50'); }
          else { el('windGust').textContent = `Gusts: N/A`; el('windGust').classList.add('opacity-50'); }
        }
        if (el('windDirDegrees') && windDirDeg !== null) el('windDirDegrees').textContent = `Direction: ${Math.round(windDirDeg)}°`;
        const windDirLabel = degToCardinal(windDirDeg);
        if (el('windDirLabel')) el('windDirLabel').textContent = `Wind From: ${windDirLabel}`;

        const fStrip = el('forecastStrip');
        if (fStrip && hourly && hourly.time) {
          const now = Date.now(); const hrs = [];
          for (let i = 0; i < hourly.time.length && hrs.length < 12; i++) {
            const t = Date.parse(hourly.time[i]);
            if (t > now) hrs.push({ time: new Date(t), speed: hourly.wind_speed_10m[i], dirDeg: hourly.wind_direction_10m[i] });
          }
          fStrip.innerHTML = hrs.map(h => {
            const hour = h.time.getHours().toString().padStart(2,'0');
            const label = degToCardinal(h.dirDeg);
            return `
              <div class="bg-background-light dark:bg-background-dark p-3 rounded-lg shadow-md border border-gray-300 dark:border-gray-600 text-center">
                <p class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark">${hour}:00</p>
                <span class="material-symbols-outlined text-primary text-2xl weather-spin">air</span>
                <p class="font-bold text-gray-900 dark:text-white">${Math.round(h.speed||0)} mph</p>
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">${label}</p>
              </div>
            `;
          }).join('');
        }

        applyCompassRotation(windDirDeg);
        const siteKey = (degToCardinal(windDirDeg) || 'NW');

        const numericWind = (typeof windSpeed === 'number') ? windSpeed : (parseInt(el('windSpeed')?.textContent || '') || null);
        window.latestWindSpeed = numericWind;
        updateWeatherIconSpin(numericWind);
        if (typeof window.updateGliderAdvice === 'function') window.updateGliderAdvice(numericWind);

        if (el('updated')) {
          const stamp = (hourly && hourly.time && hourly.time[0]) ? new Date(hourly.time[0]) : new Date();
          el('updated').textContent = `Last update: ${stamp.toLocaleString()}`;
        }

        // Optional: call generateTextForecast(hourly) if you add that function
      } catch (err) {
        console.error('Open-Meteo fetch error', err);
        const updatedEl = el('updated');
        if (updatedEl) {
          const prev = updatedEl.dataset && updatedEl.dataset.lastSuccess ? new Date(updatedEl.dataset.lastSuccess) : null;
          if (prev) updatedEl.textContent = `Last update: ${prev.toLocaleString()} (offline)`;
          else updatedEl.textContent = 'Last update: unavailable';
          updatedEl.classList.add('text-red-600');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchAndRenderWeather();
      setInterval(fetchAndRenderWeather, 300000);

      const bW = el('btnWindy'), bO = el('btnOpenMeteo');
      if (bW) bW.addEventListener('click', () => {
        const radarFrame = el('weatherRadarIframe');
        if (radarFrame && radarFrame.dataset && radarFrame.dataset.src) {
          radarFrame.src = radarFrame.dataset.src;
          radarFrame.setAttribute('data-src-loaded', 'true');
        }
        bW.classList.add('toggle-active'); bW.classList.remove('toggle-inactive');
        bO.classList.remove('toggle-active'); bO.classList.add('toggle-inactive');
      });
      if (bO) bO.addEventListener('click', () => {
        bO.classList.add('toggle-active'); bO.classList.remove('toggle-inactive');
        if (bW) { bW.classList.remove('toggle-active'); bW.classList.add('toggle-inactive'); }
      });
    });
  </script>
</body>
</html>
